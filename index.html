<!DOCTYPE html>
<html lang="lb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>P4 – Sazstruktur (Inversioun)</title>

  <style>
    /* FONT */
    @font-face{
      font-family:'Schoulschrëft';
      src:url('https://raw.githubusercontent.com/albrechtclaire1007/schoulschreft/main/schoulschreft_bold%5B2%5D.TTF') format('truetype');
      font-weight:bold;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --purple-mid:#b7a2e5;
      --purple-light:#ebe3ff;
      --purple-dark:#6c4aa3;
      --ink:#2d1844;
      --white:#fff;

      /* Handout colours */
      --subj:#b7f0c8;   /* green */
      --verb:#e6dcff;   /* purple-ish */
      --gar:#ffd9c4;    /* orange */
      --info:#dbefff;   /* blue */

      --border: rgba(108,74,163,.18);
      --dash: rgba(108,74,163,.35);
    }

    *{ margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Schoulschrëft', system-ui, sans-serif;
      background:var(--purple-light);
      padding:16px;
      color:var(--ink);
      min-height:100vh;
    }

    button{
      font-family:'Schoulschrëft', system-ui, sans-serif;
      cursor:pointer;
    }

    /* TOP BAR */
    .top-bar{
      max-width:1100px;
      margin:0 auto 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--purple-dark);
      border-radius:999px;
      padding:10px 14px;
      color:var(--white);
      box-shadow: 0 10px 18px rgba(45,24,68,.12);
      text-align:center;
      font-size:1.45rem;
      line-height:1.1;
    }

    .instruction-box{
      max-width:1100px;
      margin:0 auto 14px;
      background:var(--white);
      border-radius:18px;
      padding:12px 16px;
      text-align:center;
      font-size:1.35rem;
      border:2px solid rgba(108,74,163,.15);
    }

    .row-center{
      max-width:1100px;
      margin: 0 auto 14px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .primary{
      padding:10px 18px;
      border-radius:999px;
      border:2px solid var(--purple-dark);
      background:var(--purple-mid);
      color:var(--white);
      font-size:1.25rem;
    }
    .secondary{
      padding:8px 14px;
      border-radius:999px;
      border:2px solid rgba(108,74,163,.25);
      background:white;
      color:var(--ink);
      font-size:1.15rem;
    }
    .pill{
      background:var(--white);
      border-radius:999px;
      padding:8px 14px;
      border:2px solid rgba(108,74,163,.15);
      font-size:1.2rem;
    }

    .board{
      width:min(980px, 100%);
      margin:0 auto;
      background: rgba(255,255,255,.35);
      border:2px solid rgba(108,74,163,.10);
      border-radius:22px;
      padding:14px 14px 10px;
    }

    .sectionTitle{
      text-align:left;
      font-size:1.35rem;
      color: var(--purple-dark);
      margin: 6px 2px 10px;
      opacity:.95;
    }

    .row{
      display:flex;
      justify-content:center;
      align-items:flex-end;
      flex-wrap:wrap;
      gap:14px;
      margin: 0 auto 6px;
    }

    /* Handout-style pill stack */
    .stack{
      width:min(240px, 46vw);
      min-width: 150px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }

    .wordPill{
      width:100%;
      border-radius:999px;
      padding:14px 14px;
      font-size:1.9rem;
      text-align:center;
      border:2px solid rgba(0,0,0,.06);
      background: var(--white);
      user-select:none;
      word-break:break-word;
    }

    .roleLabel{
      font-size:1.25rem;
      opacity:.85;
      text-align:center;
      min-height: 1.2em;
    }

    .numCircle{
      width:44px;
      height:44px;
      border-radius:999px;
      border:3px solid #000;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.4rem;
      line-height:1;
    }

    .subj{ background: var(--subj); }
    .verb{ background: var(--verb); }
    .gar { background: var(--gar); }
    .info{ background: var(--info); }

    /* draggable top pills */
    .bankPill{
      cursor:grab;
    }
    .bankPill:active{ transform: scale(.99); }
    .bankPill.used{
      opacity:.25;
      filter:grayscale(.2);
      cursor:default;
    }
    .selected{
      outline: 5px solid rgba(108,74,163,.22);
      outline-offset: 3px;
    }

    /* target drop slots */
    .drop{
      border: 2px dashed var(--dash);
      background: rgba(255,255,255,.75);
    }
    .drop.over{
      outline:4px solid rgba(108,74,163,.18);
      outline-offset:2px;
    }
    .drop.filled{
      border-style:solid;
      background: var(--white);
    }

    .punct{
      font-size:2.4rem;
      color: var(--purple-dark);
      padding: 0 6px 10px;
      line-height:1;
    }

    .feedback{
      margin: 10px auto 2px;
      min-height:1.4em;
      font-size:1.35rem;
      text-align:center;
    }
    .feedback.ok{ color:#117a3a; }
    .feedback.bad{ color:#b02323; }

    .flash-green{ animation: flashGreen .25s ease; }
    .flash-red{ animation: flashRed .25s ease; }
    @keyframes flashGreen{
      0%{ box-shadow:none; }
      50%{ box-shadow: 0 0 0 6px rgba(183,240,200,.95); }
      100%{ box-shadow:none; }
    }
    @keyframes flashRed{
      0%{ box-shadow:none; }
      50%{ box-shadow: 0 0 0 6px rgba(255,204,204,.95); }
      100%{ box-shadow:none; }
    }

    .magic{ animation: magicPop .45s ease; }
    @keyframes magicPop{
      0%   { transform:scale(1); filter:brightness(1); }
      35%  { transform:scale(1.08); filter:brightness(1.18); }
      100% { transform:scale(1); filter:brightness(1); }
    }

    @media (max-width:520px){
      .wordPill{ font-size:1.65rem; padding:12px 12px; }
      .numCircle{ width:40px; height:40px; font-size:1.25rem; }
      .punct{ font-size:2.1rem; }
    }
  </style>
</head>

<body>
  <div class="top-bar">P4 – Sazstruktur mat “gär”</div>

  <div class="instruction-box">
    Lies de Saz a kuck der d'Sazdeeler un. Verwandel de Saz an eng Fro oder d'Fro an e Saz andeems du d'Sazdeeler op déi richteg Plaz zitts.
  </div>

  <div class="row-center">
    <button class="secondary" id="resetBtn">Reset</button>
    <button class="secondary" id="checkBtn">Kontrolléieren</button>
    <button class="primary" id="nextBtn">Nächst Beispill</button>
    <div class="pill" id="prog">1 / …</div>
  </div>

  <div class="board">
    <div class="sectionTitle" id="topTitle">Uewen</div>
    <div class="row" id="topRow"></div>

    <div style="height:10px;"></div>

    <div class="sectionTitle" id="bottomTitle">Ënnen</div>
    <div class="row" id="bottomRow"></div>

    <div class="feedback" id="fb"></div>
  </div>

<script>
/* ===================== HELPERS ===================== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function flash(el, cls){
  el.classList.remove("flash-green","flash-red","magic");
  void el.offsetWidth;
  el.classList.add(cls);
}
function setFb(text, ok){
  const el = document.getElementById("fb");
  el.textContent = text;
  el.className = "feedback " + (ok ? "ok" : "bad");
}
function clearFb(){
  const el = document.getElementById("fb");
  el.textContent = "";
  el.className = "feedback";
}
function magic(el){
  el.classList.remove("magic");
  void el.offsetWidth;
  el.classList.add("magic");
}

/* ===================== CONJUGATION (ECH/DU) ===================== */
const IRREG = {
  "fueren":   { ech:"fueren", du:"fiers" },
  "danzen":   { ech:"danzen", du:"danz"  },
  "liesen":   { ech:"liesen", du:"lies"  },
  "schwammen":{ ech:"schwammen", du:"schwëmms" },
  "molen":    { ech:"molen", du:"mools" },
  "lafen":    { ech:"lafen", du:"leefs" },
  "maachen":  { ech:"maachen", du:"méchs" },
  "spillen":  { ech:"spillen", du:"spills" }
};
const REG = ["lauschteren","kucken","boxen","kachen","léieren","raschten","spadséieren","telefonéieren"];

function stemOf(inf){
  if(inf.endsWith("en")) return inf.slice(0,-2);
  return inf;
}
function conjEch(inf){
  if(IRREG[inf]) return IRREG[inf].ech;
  return stemOf(inf) + "en";
}
function conjDu(inf){
  if(IRREG[inf]) return IRREG[inf].du;
  return stemOf(inf) + "s";
}

/* ===================== EXAMPLES ===================== */
const EX = [
  { verb:"schwammen", gar:"gär",     info:null },
  { verb:"spillen",   gar:"gär",     info:"Fussball" },
  { verb:"kucken",    gar:"net gär", info:"Tëlee" },
  { verb:"lauschteren",gar:"gär",    info:"Musek" },
  { verb:"liesen",    gar:"gär",     info:null },
  { verb:"danzen",    gar:"net gär", info:null },
  { verb:"lafen",     gar:"gär",     info:null },
  { verb:"maachen",   gar:"net gär", info:"Sport" },
  { verb:"telefonéieren",gar:"gär",  info:null },
  { verb:"raschten",  gar:"net gär", info:null },
  { verb:"kachen",    gar:"gär",     info:null },
  { verb:"spadséieren",gar:"gär",    info:null },
  { verb:"molen",     gar:"net gär", info:null },
  { verb:"léieren",   gar:"gär",     info:null },
  { verb:"boxen",     gar:"net gär", info:null }
];

let order = shuffle(EX);
let pos = 0;
let current = null;

// givenMode: "AFF" (Ech ... .) OR "Q" (Verb du ... ?)
let givenMode = "AFF";
let needInfo = false;

// click-to-place support
let selectedTile = null;

// placed map by slot index in bottom (1..4)
let placed = {1:null,2:null,3:null,4:null}; // {token, rawText}

/* ===================== GRAMMAR RULES FROM HANDOUT ===================== */
function topStructure(){
  // top shows either:
  // AFF: 1 Sujet (Ech), 2 Verb (ech-form), 3 (net) gär, 4 Info?
  // Q  : 1 Verb (du-form), 2 Sujet (du), 3 (net) gär, 4 Info?
  const base = [
    givenMode==="AFF"
      ? {token:"SUBJ", cls:"subj", label:"Sujet", text:"Ech"}
      : {token:"VERB", cls:"verb", label:"Verb",  text:conjDu(current.verb)},
    givenMode==="AFF"
      ? {token:"VERB", cls:"verb", label:"Verb",  text:conjEch(current.verb)}
      : {token:"SUBJ", cls:"subj", label:"Sujet", text:"du"},
    {token:"GAR", cls:"gar", label:"(net) gär", text:current.gar}
  ];
  if(needInfo){
    base.push({token:"INFO", cls:"info", label:"Informatioun", text:current.info});
  }
  return base;
}

function targetStructure(){
  // bottom must be the OTHER form:
  // if top AFF -> bottom Q: 1 Verb(du), 2 Sujet(du), 3 (net) gär, 4 Info?
  // if top Q   -> bottom AFF: 1 Sujet(Ech), 2 Verb(ech), 3 (net) gär, 4 Info?
  const targetIsQuestion = (givenMode==="AFF");
  const base = [
    targetIsQuestion
      ? {token:"VERB", cls:"verb", label:"Verb", text:conjDu(current.verb)}
      : {token:"SUBJ", cls:"subj", label:"Sujet", text:"Ech"},
    targetIsQuestion
      ? {token:"SUBJ", cls:"subj", label:"Sujet", text:"du"}
      : {token:"VERB", cls:"verb", label:"Verb", text:conjEch(current.verb)},
    {token:"GAR", cls:"gar", label:"(net) gär", text:current.gar}
  ];
  if(needInfo){
    base.push({token:"INFO", cls:"info", label:"Informatioun", text:current.info});
  }
  return base;
}

function topPunct(){ return givenMode==="AFF" ? "." : "?"; }
function bottomPunct(){ return givenMode==="AFF" ? "?" : "."; }

/* ===================== UI BUILD ===================== */
function makeStackPill({cls,label,text,token}, number, {draggable=false, id=null, isDrop=false} = {}){
  const stack = document.createElement("div");
  stack.className = "stack";

  const pill = document.createElement("div");
  pill.className = `wordPill ${cls} ${draggable ? "bankPill" : ""} ${isDrop ? "drop" : ""}`;
  pill.textContent = text;
  if(id) pill.id = id;

  // store token/text for drag
  pill.dataset.token = token;
  pill.dataset.raw = text;

  if(draggable){
    pill.draggable = true;
    pill.addEventListener("dragstart", (e)=>{
      if(pill.classList.contains("used")) return e.preventDefault();
      e.dataTransfer.setData("text/plain", JSON.stringify({token, raw:text, srcId: pill.id}));
    });

    // click-to-select
    pill.addEventListener("click", ()=>{
      if(pill.classList.contains("used")) return;
      if(selectedTile && selectedTile !== pill){
        selectedTile.classList.remove("selected");
      }
      selectedTile = pill;
      pill.classList.toggle("selected");
      if(!pill.classList.contains("selected")) selectedTile = null;
    });
  }

  const role = document.createElement("div");
  role.className = "roleLabel";
  role.textContent = label;

  const num = document.createElement("div");
  num.className = "numCircle";
  num.textContent = String(number);

  stack.appendChild(pill);
  stack.appendChild(role);
  stack.appendChild(num);

  return stack;
}

function renderTop(){
  const topRow = document.getElementById("topRow");
  topRow.innerHTML = "";

  const struct = topStructure();

  // title
  document.getElementById("topTitle").textContent =
    givenMode==="AFF" ? "Sazstruktur (Ausso)" : "Frostruktur (Fro)";

  struct.forEach((item, idx)=>{
    const id = `bank_${idx+1}`;
    const stack = makeStackPill(item, idx+1, {draggable:true, id});
    topRow.appendChild(stack);
  });

  // punctuation
  const p = document.createElement("div");
  p.className = "punct";
  p.textContent = topPunct();
  topRow.appendChild(p);
}

function renderBottom(){
  const bottomRow = document.getElementById("bottomRow");
  bottomRow.innerHTML = "";

  const struct = targetStructure();

  document.getElementById("bottomTitle").textContent =
    givenMode==="AFF" ? "Frostruktur (du)" : "Sazstruktur (ech)";

  // Create empty drop slots in target order
  struct.forEach((item, idx)=>{
    const slotId = `slot_${idx+1}`;
    const stack = makeStackPill(
      {cls:item.cls, label:item.label, text:String(idx+1), token:item.token},
      idx+1,
      {draggable:false, id:slotId, isDrop:true}
    );

    const pill = stack.querySelector(".wordPill");
    pill.dataset.slot = String(idx+1);
    pill.dataset.expected = item.token;

    // drag events
    pill.addEventListener("dragover", (e)=>{ e.preventDefault(); pill.classList.add("over"); });
    pill.addEventListener("dragleave", ()=> pill.classList.remove("over"));
    pill.addEventListener("drop", (e)=>{
      e.preventDefault();
      pill.classList.remove("over");
      let data = null;
      try{ data = JSON.parse(e.dataTransfer.getData("text/plain")); }catch(_){}
      if(!data) return;
      placeIntoSlot(pill, data.token, data.raw, data.srcId);
    });

    // click-to-place
    pill.addEventListener("click", ()=>{
      if(selectedTile && selectedTile.classList.contains("selected")){
        const token = selectedTile.dataset.token;
        const raw = selectedTile.dataset.raw;
        const srcId = selectedTile.id;
        placeIntoSlot(pill, token, raw, srcId);
      }
    });

    bottomRow.appendChild(stack);
  });

  // punctuation
  const p = document.createElement("div");
  p.className = "punct";
  p.textContent = bottomPunct();
  bottomRow.appendChild(p);
}

function clearBottom(){
  placed = {1:null,2:null,3:null,4:null};
  clearFb();

  // reset slots
  const struct = targetStructure();
  for(let i=1;i<=4;i++){
    const el = document.getElementById(`slot_${i}`);
    if(!el) continue;
    el.classList.remove("filled","flash-green","flash-red","magic","over");
    el.textContent = String(i);

    // Hide slot 4 when no info
    el.closest(".stack").style.display = (needInfo || i!==4) ? "flex" : "none";
  }

  // reset top pills visibility
  document.querySelectorAll(".bankPill").forEach(p=>{
    p.classList.remove("used","selected");
    p.style.pointerEvents = "";
    p.style.opacity = "";
  });
  selectedTile = null;

  // also hide top stack4 if no info
  const topStacks = document.querySelectorAll("#topRow .stack");
  topStacks.forEach((st, idx)=>{
    if(idx===3){ // 4th stack
      st.style.display = needInfo ? "flex" : "none";
    }
  });
}

function transformForTarget(token){
  // token transforms to the TARGET person/order form, regardless of where placed
  const targetIsQuestion = (givenMode==="AFF");
  if(token==="SUBJ") return targetIsQuestion ? "du" : "Ech";
  if(token==="VERB") return targetIsQuestion ? conjDu(current.verb) : conjEch(current.verb);
  if(token==="GAR")  return current.gar;         // keep gär vs net gär
  if(token==="INFO") return current.info;
  return "";
}

function placeIntoSlot(slotEl, token, raw, srcId){
  // allow wrong placements (any token any slot)
  if(slotEl.classList.contains("filled")) return;

  // If src tile is already used, don't allow reuse
  const src = document.getElementById(srcId);
  if(!src || src.classList.contains("used")) return;

  // fill slot with transformed text, keep colour of the SLOT (handout style)
  slotEl.classList.add("filled");
  slotEl.textContent = raw;        // show what they dragged for a moment
  magic(slotEl);

  // transform after short moment
  setTimeout(()=>{
    slotEl.textContent = transformForTarget(token);
  }, 170);

  // mark src as used
  src.classList.add("used");
  src.classList.remove("selected");
  src.draggable = false;

  // store placement
  const slotNum = Number(slotEl.dataset.slot);
  placed[slotNum] = {token, raw};

  selectedTile = null;
}

function checkAnswer(){
  clearFb();
  const struct = targetStructure(); // expected token order for bottom slots

  // must have all required placed
  const requiredCount = needInfo ? 4 : 3;
  for(let i=1;i<=requiredCount;i++){
    if(!placed[i]){
      setFb("Fëll nach all d’Plazen aus.", false);
      return;
    }
  }

  let allOk = true;

  for(let i=1;i<=requiredCount;i++){
    const slotEl = document.getElementById(`slot_${i}`);
    const expectedToken = struct[i-1].token; // by order
    const gotToken = placed[i].token;

    if(gotToken === expectedToken){
      flash(slotEl, "flash-green");
    }else{
      flash(slotEl, "flash-red");
      allOk = false;
    }
  }

  if(allOk){
    setFb("Richteg!", true);
  }else{
    setFb("Nach net ganz. Probéier nach eng Kéier.", false);
  }
}

/* ===================== ROUND CONTROL ===================== */
function loadRound(){
  current = order[pos];
  needInfo = !!current.info;
  givenMode = (Math.random() < 0.5) ? "AFF" : "Q";

  document.getElementById("prog").textContent = `${pos+1} / ${order.length}`;

  renderTop();
  renderBottom();
  clearBottom();
}

function nextRound(){
  pos++;
  if(pos >= order.length){
    order = shuffle(EX);
    pos = 0;
  }
  loadRound();
}

/* ===================== BUTTONS + INIT ===================== */
document.getElementById("resetBtn").addEventListener("click", ()=> loadRound());
document.getElementById("nextBtn").addEventListener("click", ()=> nextRound());
document.getElementById("checkBtn").addEventListener("click", ()=> checkAnswer());

// Initial
loadRound();
</script>
</body>
</html>

